<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Analysis Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#673ab7',
                            '50': '#ede7f6',
                            '100': '#d1c4e9',
                            '200': '#b39ddb',
                            '300': '#9575cd',
                            '400': '#7e57c2',
                            '500': '#673ab7',
                            '600': '#5e35b1',
                            '700': '#512da8',
                            '800': '#4527a0',
                            '900': '#311b92',
                        },
                        // Th√™m m√†u ƒë·ªè v√† xanh cho bi·ªÉu ƒë·ªì
                        red: { DEFAULT: '#f44336', 'dark': '#d32f2f', 'light': 'rgba(244, 67, 54, 0.1)' },
                        green: { DEFAULT: '#4caf50', 'dark': '#388e3c', 'light': 'rgba(76, 175, 80, 0.1)' },
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        #transcriptText::-webkit-scrollbar { width: 6px; }
        #transcriptText::-webkit-scrollbar-thumb { background-color: #b39ddb; border-radius: 3px; }
        #transcriptText::-webkit-scrollbar-track { background-color: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    </style>
</head>
<body class="antialiased">

    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <svg class="h-8 w-8 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z" />
                    </svg>
                    <span class="text-2xl font-bold text-primary-700">Call Analysis Dashboard</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
        
        <div id="status" class="hidden rounded-lg p-4 text-sm font-medium mb-6"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <aside class="lg:col-span-1 space-y-8">
                <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                    <div class="p-5 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Analyze New Call</h2>
                    </div>
                    <div class="p-6 space-y-5">
                        <div>
                            <label for="audioFile" class="block text-sm font-medium text-gray-700 mb-1.5">Upload Audio File</label>
                            <input id="audioFile" type="file" accept="audio/*" class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-lg file:border-0
                                file:text-sm file:font-semibold
                                file:bg-primary-50 file:text-primary-700
                                hover:file:bg-primary-100 cursor-pointer"/>
                        </div>
                        
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center">
                                <span class="px-2 bg-white text-sm text-gray-500">OR</span>
                            </div>
                        </div>

                        <div>
                            <label for="audioUrl" class="block text-sm font-medium text-gray-700 mb-1.5">Enter Audio File URL</label>
                            <input type="text" id="audioUrl" placeholder="https://..." class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        </div>

                        <button id="submitBtn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                            Start Analysis
                        </button>
                    </div>
                </div>

                <div id="actionItemsCard" class="bg-white shadow-lg rounded-xl overflow-hidden hidden">
                    <div class="p-5 border-b border-gray-200 flex items-center space-x-3">
                        <svg class="w-6 h-6 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>
                        <h2 class="text-lg font-semibold text-gray-900">Action Items</h2>
                    </div>
                    <div class="p-6">
                        <ul id="actionItemsList" class="space-y-4">
                            </ul>
                    </div>
                </div>
            </aside>

            <main id="results" class="lg:col-span-2 space-y-8 hidden">
                
                <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                    <div class="p-5 border-b border-gray-200 flex items-center space-x-3">
                        <svg class="w-6 h-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>
                        <h2 class="text-lg font-semibold text-gray-900">Call Summary</h2>
                    </div>
                    <div id="summaryText" class="p-6 text-base text-gray-600 leading-relaxed">
                        </div>
                </div>

                <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                    <div class="p-5 border-b border-gray-200 flex items-center space-x-3">
                         <svg class="w-6 h-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h12M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-1.5m-15 0v2.25A2.25 2.25 0 0 0 3.75 21h16.5M3.75 21h16.5m0 0h1.5m-1.5 0v-2.25A2.25 2.25 0 0 0 18 16.5h-1.5m-15 0h1.5" /></svg>
                        <h2 class="text-lg font-semibold text-gray-900">Sentiment Trend</h2>
                    </div>
                    <div class="p-6">
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>

                <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                    <div class="p-5 border-b border-gray-200 flex items-center space-x-3">
                        <svg class="w-6 h-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
                        </svg>
                        <h2 class="text-lg font-semibold text-gray-900">Media Player</h2>
                    </div>
                    <div class="p-6">
                        <audio id="audioPlayer" controls class="w-full"></audio>
                    </div>
                </div>

                <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                    <div class="p-5 border-b border-gray-200 flex items-center space-x-3">
                        <svg class="w-6 h-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.056 3 12s4.03 8.25 9 8.25Z" /></svg>
                        <h2 class="text-lg font-semibold text-gray-900">Interactive Transcript</h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div id="transcriptText" class="max-h-96 overflow-y-auto space-y-3 pr-2">
                            </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        // === S·ª¨A L·ªñI 1: D√πng window.onload ƒë·ªÉ ch·ªù m·ªçi th·ª© t·∫£i xong ===
        window.onload = () => {
            
            // === DEBUG LOG 1 ===
            console.log("DEBUG: 1. Trang ƒë√£ t·∫£i xong (window.onload). B·∫Øt ƒë·∫ßu g√°n s·ª± ki·ªán.");
            // ===================

            const API_BASE = 'http://127.0.0.1:8000/v1';
            let isProcessing = false;
            let finalAudioUrl = '';
            let sentimentChartInstance = null;
            
            const chartColors = {
                red: '#f44336',
                redDark: '#d32f2f',
                redLight: 'rgba(244, 67, 54, 0.1)',
                green: '#4caf50',
                greenDark: '#388e3c',
                greenLight: 'rgba(76, 175, 80, 0.1)'
            };

            const statusEl = document.getElementById('status');
            const submitBtn = document.getElementById('submitBtn');
            const resultsEl = document.getElementById('results');
            const summaryTextEl = document.getElementById('summaryText');
            const actionItemsListEl = document.getElementById('actionItemsList');
            const actionItemsCardEl = document.getElementById('actionItemsCard');
            const transcriptTextEl = document.getElementById('transcriptText');
            const audioPlayerEl = document.getElementById('audioPlayer');

            if(submitBtn) {
                submitBtn.onclick = startAnalysis;
            } else {
                console.error("L·ªói: Kh√¥ng t√¨m th·∫•y #submitBtn.");
            }

            function showStatus(message, type = 'info') {
                statusEl.classList.remove('hidden', 'bg-primary-50', 'text-primary-700', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
                
                if (type === 'info') {
                    statusEl.classList.add('bg-primary-50', 'text-primary-700');
                } else if (type === 'error') {
                    statusEl.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    statusEl.classList.add('bg-green-100', 'text-green-700');
                }
                statusEl.textContent = message;
            }

            function resetUI() {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                resultsEl.classList.add('hidden');
                actionItemsCardEl.classList.add('hidden');
                audioPlayerEl.src = '';
                
                summaryTextEl.innerHTML = '<div class="h-4 bg-gray-200 rounded animate-pulse w-3/4"></div><div class="h-4 bg-gray-200 rounded animate-pulse w-full mt-2"></div>';
                actionItemsListEl.innerHTML = '<div class="h-4 bg-gray-200 rounded animate-pulse w-5/6"></div>';
                transcriptTextEl.innerHTML = '<div class="h-8 bg-gray-200 rounded animate-pulse w-full"></div><div class="h-8 bg-gray-200 rounded animate-pulse w-4/5 mt-2"></div>';
                
                if (sentimentChartInstance) {
                    sentimentChartInstance.destroy();
                }
            }

            async function startAnalysis() {
                if (isProcessing) return;
                const fileInput = document.getElementById('audioFile');
                const urlInput = document.getElementById('audioUrl');
                finalAudioUrl = urlInput.value.trim();

                if (!fileInput.files[0] && !finalAudioUrl) {
                    showStatus('Please select a file or enter a URL!', 'error');
                    return;
                }

                isProcessing = true;
                resetUI();

                try {
                    if (fileInput.files[0]) {
                        showStatus('‚è≥ Uploading file to server...', 'info');
                        const formData = new FormData();
                        formData.append('file', fileInput.files[0]);
                        const uploadRes = await fetch(`${API_BASE}/uploads`, { method: 'POST', body: formData });
                        if (!uploadRes.ok) throw new Error('Upload failed');
                        finalAudioUrl = (await uploadRes.json()).uploadUrl;
                    }

                    showStatus('üöÄ Submitting analysis job...', 'info');
                    const jobRes = await fetch(`${API_BASE}/jobs`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ audioUrls: [finalAudioUrl] })
                    });
                    if (!jobRes.ok) throw new Error('Failed to create job');
                    const { id: jobId } = await jobRes.json();

                    pollJob(jobId);

                } catch (err) {
                    showStatus(`‚ùå Error: ${err.message}`, 'error');
                    isProcessing = false;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Start Analysis';
                }
            }

            async function pollJob(jobId) {
                showStatus('‚öôÔ∏è AI is analyzing... Please wait (approx. 1-2 minutes)', 'info');
                const interval = setInterval(async () => {
                    try {
                        const res = await fetch(`${API_BASE}/jobs/${jobId}`);
                        const job = await res.json();

                        if (job.status === 'completed') {
                            clearInterval(interval);
                            displayResults(job.results[0]);
                            showStatus('‚úÖ Analysis Complete!', 'success');
                            isProcessing = false;
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Start Analysis';
                        } else if (job.status === 'failed') {
                            clearInterval(interval);
                            throw new Error(job.error || 'Analysis failed');
                        }
                    } catch (err) {
                        clearInterval(interval);
                        showStatus(`‚ùå Error polling status: ${err.message}`, 'error');
                        isProcessing = false;
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Start Analysis';
                    }
                }, 5000);
            }

            function displayResults(data) {
                // === DEBUG LOG 2 ===
                console.log("DEBUG: 2. ƒê√£ g·ªçi h√†m displayResults. ƒêang x·ª≠ l√Ω Summary v√† Action Items.");
                // ===================

                resultsEl.classList.remove('hidden');

                // 1. Summary
                summaryTextEl.textContent = data.summary.summary;

                // 2. Action Items
                if(data.actionItems.action_items.length > 0) {
                    actionItemsCardEl.classList.remove('hidden');
                    actionItemsListEl.innerHTML = data.actionItems.action_items.map(item => `
                        <li class="flex items-start space-x-3">
                            <svg class="h-6 w-6 text-green-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>
                            <div>
                                <p class="text-base font-medium text-gray-800">${item.task}</p>
                                <p class="text-sm text-gray-500">Assigned to: ${item.owner}</p>
                            </div>
                        </li>
                    `).join('');
                } else {
                    actionItemsCardEl.classList.add('hidden');
                }

                // 3. Sentiment Chart
                // === DEBUG LOG 3 ===
                console.log("DEBUG: 3. S·∫Øp g·ªçi h√†m createSentimentChart.");
                // ===================
                
                if (typeof Chart === 'undefined') {
                    // === DEBUG LOG (L·ªñI) ===
                    console.error("L·ªñI NGHI√äM TR·ªåNG: Chart.js CH∆ØA T·∫¢I XONG (Chart is not defined)!");
                    // =======================
                    showStatus('L·ªói: Kh√¥ng th·ªÉ t·∫£i bi·ªÉu ƒë·ªì. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.', 'error');
                } else {
                    createSentimentChart(data.sentiment.utterance_sentiments);
                    // === DEBUG LOG 4 ===
                    console.log("DEBUG: 4. ƒê√É G·ªåI XONG createSentimentChart. S·∫Øp x·ª≠ l√Ω Transcript.");
                    // ===================
                }

                // 4. Interactive Transcript & Audio Player
                audioPlayerEl.src = finalAudioUrl;
                
                // === S·ª¨A L·ªñI 2: Th√™m l·∫°i ph√©p chia / 1000.0 ===
                transcriptTextEl.innerHTML = data.transcription.utterances.map(u => `
                    <div class="p-3 rounded-lg hover:bg-primary-50 cursor-pointer transcript-line" data-start="${u.start}">
                        <span class="font-bold text-primary-700 w-20 inline-block">Speaker ${u.speaker}:</span>
                        <span class="text-gray-700">${u.text}</span>
                    </div>
                `).join('');
                // === K·∫æT TH√öC S·ª¨A L·ªñI 2 ===

                makeTranscriptInteractive();
            }

            function createSentimentChart(sentimentData) {
                const ctx = document.getElementById('sentimentChart').getContext('2d');
                
                const labels = sentimentData.map(s => `Utterance ${s.utterance_index + 1}`);
                const scores = sentimentData.map(s => s.score);

                if (sentimentChartInstance) {
                    sentimentChartInstance.destroy();
                }

                sentimentChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sentiment Score',
                            data: scores,
                            fill: true, // B·∫≠t fill ƒë·ªÉ t·∫°o gradient n·ªÅn
                            tension: 0.3,
                            
                            // 1. M√ÄU N·ªÄN (Fill) - T·∫°o gradient 2 m√†u
                            backgroundColor: (context) => {
                                const chart = context.chart;
                                const { ctx, chartArea } = chart;
                                if (!chartArea) { return null; }
                                
                                const gradientBg = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                                const yZero = chart.scales.y.getPixelForValue(0);
                                const zeroPercent = (yZero - chartArea.top) / (chartArea.bottom - chartArea.top);
                                const zeroPoint = Math.max(0, Math.min(1, zeroPercent));

                                gradientBg.addColorStop(0, chartColors.greenLight); // V√πng t√≠ch c·ª±c (tr√™n)
                                gradientBg.addColorStop(zeroPoint, chartColors.greenLight);
                                gradientBg.addColorStop(zeroPoint, chartColors.redLight); // V√πng ti√™u c·ª±c (d∆∞·ªõi)
                                gradientBg.addColorStop(1, chartColors.redLight);
                                
                                return gradientBg;
                            },
                            
                            // 2. M√ÄU LINE (Border) - ƒê·ªïi m√†u theo ƒëo·∫°n
                            segment: {
                                borderColor: (ctx) => {
                                    const value = ctx.p1.raw; // M√†u line theo ƒëi·ªÉm K·∫æT TH√öC
                                    return value < 0 ? chartColors.red : chartColors.green;
                                }
                            },
                            
                            // 3. M√ÄU ƒêI·ªÇM (Point)
                            pointBackgroundColor: (ctx) => {
                                const value = ctx.raw;
                                return value < 0 ? chartColors.red : chartColors.green;
                            },
                            pointHoverBackgroundColor: (ctx) => {
                                const value = ctx.raw;
                                return value < 0 ? chartColors.redDark : chartColors.greenDark;
                            },
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: -1,
                                max: 1,
                                ticks: { stepSize: 0.5, color: '#4b5563' },
                                grid: { color: '#e5e7eb' }
                            },
                            x: {
                                ticks: { color: '#4b5563' },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: true,
                                backgroundColor: (ctx) => {
                                    const value = ctx.tooltip.dataPoints[0].raw;
                                    return value < 0 ? chartColors.redDark : chartColors.greenDark;
                                },
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 12 },
                                padding: 10,
                                cornerRadius: 6,
                                callbacks: {
                                    label: (context) => `Score: ${context.parsed.y.toFixed(2)}`
                                }
                            }
                        }
                    }
                });
            }

            function makeTranscriptInteractive() {
                // === DEBUG LOG 5 ===
                console.log("DEBUG: 5. ƒê√£ g·ªçi h√†m makeTranscriptInteractive (g·∫Øn s·ª± ki·ªán click).");
                // ===================
                
                if (transcriptTextEl) {
                    transcriptTextEl.onclick = function(event) {
                        // === DEBUG LOG 6 ===
                        console.log("DEBUG: 6. ƒê√É CLICK V√ÄO D√íNG TRANSCRIPT!");
                        // ===================

                        // T√¨m th·∫ª .transcript-line g·∫ßn nh·∫•t m√† user ƒë√£ click
                        const line = event.target.closest('.transcript-line');
                        
                        if (!line) {
                            console.warn("DEBUG: Click kh√¥ng tr√∫ng d√≤ng transcript.");
                            return; 
                        }

                        const startTime = parseFloat(line.getAttribute('data-start'));
                        
                        if (!isNaN(startTime)) {
                            // === DEBUG LOG 7 ===
                            console.log(`DEBUG: 7. ƒêang tua ƒë·∫øn gi√¢y: ${startTime}`); 
                            // ===================
                            
                            audioPlayerEl.currentTime = startTime;
                            audioPlayerEl.play();
                        } else {
                            console.error("L·ªñI CLICK: data-start kh√¥ng ph·∫£i l√† s·ªë", line.getAttribute('data-start'));
                        }
                    };
                }
            }

        }; // === K·∫æT TH√öC B·ªåC window.onload ===
    </script>
</body>
</html>